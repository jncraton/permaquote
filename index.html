<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title></title>
    <style>
    body > :not(:last-child), textarea, input {
      width: 30em;
      font-size: 24px;
      margin: 0 auto;
      display: block;
    }

    * {
      padding-block: 8px;
    }
    
    input {
      display: block;
      width: 100%;
      font-size: inherit;
    }
    </style>
  </head>

  <body>
    <label>Title<input id=title></label>
    <label>Excerpt
    <textarea id=text spellcheck=false>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</textarea></label>
    <label>Source URL<input id=src value="https://en.wikipedia.org/wiki/Lorem_ipsum"></label>
    <p id=len></p>

    <main>
      <h1 id=out_title></h1>
      <blockquote id=out_text></blockquote>
    </main>
    
    <script>
    async function encode(text, algo) {
      let stream = new Blob([text]).stream()

      if (algo) {
        stream = stream.pipeThrough(new CompressionStream(algo))
      }
      const res = await new Response(stream)

      const blob = await res.blob()
      const buffer = await blob.arrayBuffer()
      
      return btoa(String.fromCharCode(...new Uint8Array(buffer)))
    }

    async function decode(text, algo) {
      const binary = Uint8Array.from(atob(text), c => c.charCodeAt(0))

      let stream = new Blob([binary]).stream()

      if (algo) {
        stream = stream.pipeThrough(new DecompressionStream(algo))
      }

      const res = await new Response(stream)
      const blob = await res.blob()
      return await blob.text()
    }

    function encodeURL(url) {
      url = encodeURIComponent(url)
      url = url.replace(/%3A/g, ":")
      url = url.replace(/%2F/g, "/")
      return url
    }

    function encodeTitle(title) {
      title = encodeURIComponent(title)
      title = title.replace(/%20/g, "+")
      return title
    }

    async function update() {
      let excerpt = await encode(text.value, 'deflate-raw')
      len.textContent = excerpt.length
      window.location.hash = encodeURL(src.value) + ";" + encodeTitle(title.value) + ";" + excerpt
      render()
    }

    function render() {
      out_title.textContent = title.value
      out_text.innerHTML = text.value.replaceAll("\n\n","<p>")
    }

    document.querySelectorAll("input, textarea").forEach(el => {
      el.addEventListener('input', update)
    })

    async function load() {
      let [fsrc, ftitle, excerpt] = location.hash.slice(1).split(";")
      src.value = fsrc
      title.value = ftitle
      text.value = await decode(excerpt, 'deflate-raw')
      update()
    }
    load()
    </script>
  </body>
</html>
