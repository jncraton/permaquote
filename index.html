<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title></title>
    <style>
    body > :not(:last-child), textarea, input {
      width: 30em;
      font-size: 24px;
      margin: 0 auto;
      display: block;
    }

    * {
      padding-block: 8px;
    }
    
    input {
      display: block;
      width: 100%;
      font-size: inherit;
    }
    </style>
  </head>

  <body>
    <p id=text contenteditable spellcheck=false>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    <label>Source URL<input id=src value="https://en.wikipedia.org/wiki/Lorem_ipsum"></label>
    <p id=len></p>
    <script>
    async function encode(text, algo) {
      let stream = new Blob([text]).stream()

      if (algo) {
        stream = stream.pipeThrough(new CompressionStream(algo))
      }
      const res = await new Response(stream)

      const blob = await res.blob()
      const buffer = await blob.arrayBuffer()
      
      return btoa(String.fromCharCode(...new Uint8Array(buffer)))
    }

    async function decode(text, algo) {
      const binary = Uint8Array.from(atob(text), c => c.charCodeAt(0))

      let stream = new Blob([binary]).stream()

      if (algo) {
        stream = stream.pipeThrough(new DecompressionStream(algo))
      }

      const res = await new Response(stream)
      const blob = await res.blob()
      return await blob.text()
    }

    async function update() {
      let frag = await encode(text.textContent, 'deflate-raw')
      len.textContent = frag.length
      window.location.hash = frag
    }

    text.addEventListener('input', update)

    async function load() {
      text.textContent = await decode(window.location.hash.slice(1), 'deflate-raw')
      update()
    }
    load()
    </script>
  </body>
</html>
